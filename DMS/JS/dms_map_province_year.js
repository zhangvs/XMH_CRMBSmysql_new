var myChart; var eCharts; var series_data = []; var provinceIds = []; var provinceNames = []; var provinceValues = []; var brandId = ''; var brandText = ''; var provinceBrandValues = []; var provinceBrandInZb = []; var goodId = ''; var goodTextBox = ''; var syear; var sumValue; var sumBrandValue; var provinceZb = []; var provinceBrandOutZb = []; $(function () { $("#toolbar").ligerToolBar({ items: [{ type: 'textbox', id: "syear", text: "年度：" }, { type: 'textbox', id: 'tree1', text: '品牌：' }, { type: 'textbox', id: 'goodTxt', text: ' 单品关键词：' }, { type: 'button', text: '统计', icon: '../../images/search.gif', disable: true, click: function () { doserch() } }] }); initSelect(); DrawEChart(); doserch() }); function initSelect() { var d = new Date(); var nowYear = +d.getFullYear(); var syearData = []; for (var i = nowYear; i >= nowYear - 10; i--) { syearData.push({ 'text': i, 'id': i }) } $("#syear").ligerComboBox({ width: 100, selectBoxHeight: 300, data: syearData, initValue: nowYear, onSelected: function (id, text) { syear = text } }); $('#tree1').ligerComboBox({ width: 250, selectBoxWidth: 250, selectBoxHeight: 710, valueField: 'id', textField: 'text', treeLeafOnly: true, tree: { url: '../Reports_DMS.ashx?Action=getCheckBrandTree&rnd=' + Math.random(), idFieldName: 'id', checkbox: true }, onSelected: function (id, text) { brandId = id; brandText = text } }); $('#goodTxt').ligerTextBox({ width: 250 }); $("#goodTxt").autocomplete({ minLength: 1, source: function (request, response) { $.ajax({ type: "POST", url: "../Reports_DMS.ashx", data: { Action: "getYearGoodTxt", brandIdList: brandId, syear: syear, keyWord: request.term, rnd: Math.random() }, dataType: "json", success: function (data) { response($.map(data.Rows, function (item) { return { id: item.goods_id, value: item.goods_name } })) }, error: function () { alert("ajax请求失败") } }) }, change: function (event, ui) { goodId = '' }, select: function (event, ui) { goodId = ui.item.id } }) } function doserch() { $.ligerDialog.waitting('数据加载中,请稍候...'); syear = $("#syear").val(); goodTextBox = $("#goodTxt").val(); if (true) { } $.ajax({ type: "post", url: "../Reports_DMS.ashx", data: { Action: "getYearProvinceAmt", brandIdList: brandId, goodId: goodId, goodTextBox: goodTextBox, syear: syear, rnd: Math.random() }, dataType: "json", success: function (data) { if (data) { var options = myChart.getOption(); series_data = []; provinceIds = []; provinceNames = []; provinceValues = []; provinceBrandValues = []; provinceBrandInZb = []; sumAllValue = 0; sumBrandValue = 0; provinceZb = []; provinceBrandOutZb = []; if (series_data.length != data.Rows.length) { for (var j = 0; j < data.Rows.length; j++) { var allId = data.Rows[j].allId; var allName = data.Rows[j].allName; var allValue = parseFloat((data.Rows[j].allValue).toFixed()); provinceIds.push(allId); provinceNames.push(j + 1 + '.' + allName); provinceValues.push(allValue); sumAllValue += allValue; if (brandId == '' && goodTextBox == '') { series_data.push({ id: allId, name: allName, value: allValue }) } else { var brandValue = parseFloat((data.Rows[j].brandValue).toFixed()); var zb = parseFloat((data.Rows[j].zb).toFixed(2)); provinceBrandValues.push(brandValue); provinceBrandInZb.push(zb); series_data.push({ id: allId, name: allName, value: brandValue }); sumBrandValue += brandValue } } for (var s = 0; s < data.Rows.length; s++) { if (brandId == '' && goodTextBox == '') { var allValue = parseFloat((data.Rows[s].allValue).toFixed()); provinceZb.push(parseFloat((allValue / sumAllValue * 100).toFixed(2))) } else { var brandValue = parseFloat((data.Rows[s].brandValue).toFixed()); provinceBrandOutZb.push(parseFloat((brandValue / sumBrandValue * 100).toFixed(2))) } } } options.title[0].text = '新明辉' + syear + '年份各省份销售分布'; if (brandId == '' && goodTextBox == '') { options.title[0].subtext = '所有品牌 \n总销量合计：' + sumAllValue; options.legend[0].selected = { '总销量': true, '省份销量全国占比': false, '选择项销量': false, '选择项全国占比': false, '选择项省内占比': false } } else { options.legend[0].selected = { '总销量': false, '省份销量全国占比': false, '选择项销量': true, '选择项全国占比': false, '选择项省内占比': false }; if (brandId != '' && goodTextBox != '') { options.title[0].subtext = '品牌：' + brandText + '\n单品关键词：' + goodTextBox + '\n总销量合计：' + sumAllValue + ' 选择项合计：' + sumBrandValue + ' 选择项占比：' + parseFloat((sumBrandValue / sumAllValue * 100).toFixed(2)) + '%' } else if (goodTextBox != '') { options.title[0].subtext = '单品关键词：' + goodTextBox + '\n总销量合计：' + sumAllValue + ' 选择项合计：' + sumBrandValue + ' 选择项占比：' + parseFloat((sumBrandValue / sumAllValue * 100).toFixed(2)) + '%' } else if (brandId != '') { options.title[0].subtext = '品牌：' + brandText + '\n总销量合计：' + sumAllValue + ' 选择项合计：' + sumBrandValue + ' 选择项占比：' + parseFloat((sumBrandValue / sumAllValue * 100).toFixed(2)) + '%' } } options.series[0].data = series_data; options.yAxis[0].data = provinceNames.reverse(); options.series[1].data = provinceValues.reverse(); options.series[2].data = provinceZb.reverse(); options.series[3].data = provinceBrandValues.reverse(); options.series[4].data = provinceBrandOutZb.reverse(); options.series[5].data = provinceBrandInZb.reverse(); myChart.hideLoading(); myChart.setOption(options) } $.ligerDialog.closeWaitting() }, error: function (errorMsg) { alert("图表请求数据失败啦!"); myChart.hideLoading() } }) } function DrawEChart(ec) { var h = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight; $("#main").css("height", h - 30); eCharts = ec; myChart = echarts.init(document.getElementById('main')); myChart.showLoading({ text: "图表数据正在努力加载..." }); var options = { backgroundColor: '#404a59', animation: true, animationDuration: 1000, animationEasing: 'cubicInOut', animationDurationUpdate: 1000, animationEasingUpdate: 'cubicInOut', title: { text: '新明辉' + $("#syear").val() + '年份各省份销售分布', left: 'center', textStyle: { color: '#fff' }, subtextStyle: { fontSize: 13 } }, legend: { orient: 'horizontal', y: 20, x2: '5%', data: ['总销量', '省份销量全国占比', '选择项销量', '选择项全国占比', '选择项省内占比'], selected: { '总销量': true, '省份销量全国占比': false, '选择项销量': false, '选择项全国占比': false, '选择项省内占比': false }, textStyle: { color: '#fff' } }, tooltip: { show: true, trigger: 'item', formatter: function (params) { if (typeof (params.value) == "object") { var res = params.name + ' : ' + params.value[2] } else { var res = params.name + ' : ' + params.value } return res } }, visualMap: { bottom: 20, left: 40, min: 0, max: 10000000, text: ['1千万', ''], calculable: true, inRange: { color: ['#50a3ba', '#eac736', '#d94e5d'] }, textStyle: { color: '#fff' }, itemHeight: 200 }, geo: { map: 'china', zoom: '0.85', left: '10', right: '35%', label: { emphasis: { show: false } }, roam: true, itemStyle: { normal: { areaColor: '#323c48', borderColor: '#111' }, emphasis: { areaColor: '#2a333d' } } }, grid: { right: 40, top: 100, bottom: 40, width: '30%' }, xAxis: { type: 'value', scale: true, position: 'top', boundaryGap: false, splitLine: { show: false }, axisLine: { show: false }, axisTick: { show: false }, axisLabel: { margin: 2, textStyle: { color: '#aaa' } }, }, yAxis: { type: 'category', name: '省份总销量排名', nameGap: 16, axisLine: { show: false, lineStyle: { color: '#ddd' } }, axisTick: { show: false, lineStyle: { color: '#ddd' } }, axisLabel: { interval: 0, textStyle: { color: '#ddd' } }, data: [] }, series: [{ name: '销量', type: 'map', mapType: 'china', zoom: '0.85', left: '10', right: '35%', roam: false, label: { emphasis: { show: false } }, roam: true, itemStyle: { normal: { areaColor: '#323c48', borderColor: '#111' }, emphasis: { areaColor: '#2a333d' } }, label: { normal: { show: true }, emphasis: { show: true } }, data: [] }, { name: '总销量', type: 'bar', symbol: 'none', itemStyle: { normal: { color: '#D7504B', label: { show: true, position: 'right' } } }, data: [] }, { name: '省份销量全国占比', type: 'bar', symbol: 'none', itemStyle: { normal: { color: '#F4E001', label: { show: true, position: 'right', formatter: function (params, ticket, callback) { return params.value + '%' } } } }, data: [] }, { name: '选择项销量', type: 'bar', symbol: 'none', itemStyle: { normal: { color: '#C6E579', label: { show: true, position: 'right' } } }, data: [] }, { name: '选择项全国占比', type: 'bar', symbol: 'none', itemStyle: { normal: { color: '#C6E579', label: { show: true, position: 'right' } } }, data: [] }, { name: '选择项省内占比', type: 'bar', symbol: 'none', itemStyle: { normal: { color: '#F4E001', label: { show: true, position: 'right', formatter: function (params, ticket, callback) { return params.value + '%' } } } }, data: [] }] }; myChart.hideLoading(); myChart.setOption(options); myChart.on('click', function (params) { window.open('/DMS/ReportForm/dms_map_province_year_details.aspx?syear=' + $("#syear").val() + '&provinceId=' + params.data.id + '&provinceName=' + params.data.name + '&provinceValue=' + params.data.value + '&brandIdList=' + brandId + '&brandText=' + brandText + '&goodId=' + goodId + '&goodTextBox=' + goodTextBox + '&rnd=' + Math.random()) }) } var activeDialog = null; function f_openWindow(url, title, width, height) { var dialogOptions = { width: width, height: height, title: title, url: url, isResize: true, showToggle: true, timeParmName: 'a' }; activeDialog = $.ligerDialog.open(dialogOptions) }